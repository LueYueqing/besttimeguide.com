# 环境变量配置指南

## 📋 概述

本项目使用 `.env.local` 文件存储本地开发环境的环境变量。这个文件不会被提交到 Git，确保敏感信息的安全性。

## 🔧 配置步骤

### 1. 创建 `.env.local` 文件

在项目根目录创建 `.env.local` 文件：

```bash
# Windows
copy env.example .env.local

# Linux/Mac
cp env.example .env.local
```

### 2. 配置数据库连接串

打开 `.env.local` 文件，找到数据库配置部分，填入你的 PostgreSQL 连接信息：

```env
# ============================================
# 数据库配置 (PostgreSQL - Neon)
# ============================================
# 推荐使用带连接池的连接字符串（适用于大多数场景）
DATABASE_URL="postgresql://neondb_owner:npg_F26QfAiLDYJS@ep-rough-unit-a40frcro-pooler.us-east-1.aws.neon.tech/neondb?sslmode=require"

# 对于需要非连接池连接的场景（如 Prisma 迁移）
# 如果迁移时遇到连接问题，可以临时使用这个
DATABASE_URL_UNPOOLED="postgresql://neondb_owner:npg_F26QfAiLDYJS@ep-rough-unit-a40frcro.us-east-1.aws.neon.tech/neondb?sslmode=require"
```

### 3. 配置其他必要的环境变量

根据你的需求，配置以下环境变量：

#### NextAuth 配置（必需）

```env
# 生成 NextAuth Secret
# 运行命令: node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
NEXTAUTH_SECRET=your-generated-secret-key

# NextAuth URL
NEXTAUTH_URL=http://localhost:3000
```

#### Google OAuth 配置（可选，用于用户登录）

```env
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

#### 开发模式登录（可选，用于本地调试）

```env
# 启用后可以使用以下账号登录：
# 邮箱: dev@example.com
# 密码: dev123
ENABLE_DEV_LOGIN=true
```

## 📝 完整的 `.env.local` 示例

```env
# ============================================
# 数据库配置 (PostgreSQL - Neon)
# ============================================
DATABASE_URL="postgresql://neondb_owner:npg_F26QfAiLDYJS@ep-rough-unit-a40frcro-pooler.us-east-1.aws.neon.tech/neondb?sslmode=require"

# ============================================
# NextAuth 配置
# ============================================
NEXTAUTH_SECRET=your-nextauth-secret-key-change-this-in-production
NEXTAUTH_URL=http://localhost:3000

# ============================================
# Google OAuth 配置
# ============================================
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# ============================================
# 开发模式登录配置（仅开发环境）
# ============================================
ENABLE_DEV_LOGIN=true

# ============================================
# 应用配置
# ============================================
NEXT_PUBLIC_APP_NAME=BestTimeGuide
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_APP_DESCRIPTION=Find the best time for everything
```

## 🚀 使用环境变量

### 在应用中使用

Next.js 会自动加载 `.env.local` 文件中的环境变量。在代码中使用：

```typescript
// 服务端代码
const dbUrl = process.env.DATABASE_URL

// 客户端代码（需要 NEXT_PUBLIC_ 前缀）
const appUrl = process.env.NEXT_PUBLIC_APP_URL
```

### 在脚本中使用

所有脚本（包括 `seed-articles.ts`）都会自动加载 `.env.local` 文件：

```bash
# 运行 seed 脚本
npm run seed-articles

# 运行 Prisma 命令
npx prisma migrate dev
npx prisma studio
```

## 🔍 验证配置

### 1. 检查环境变量是否加载

```bash
# 在 Node.js 中测试
node -e "require('dotenv').config({ path: '.env.local' }); console.log(process.env.DATABASE_URL ? '✅ DATABASE_URL loaded' : '❌ DATABASE_URL not found')"
```

### 2. 测试数据库连接

```bash
# 使用 Prisma 测试连接
npx prisma db pull

# 或者打开 Prisma Studio
npx prisma studio
```

### 3. 运行 seed 脚本

```bash
npm run seed-articles
```

如果看到 "开始填充测试数据..." 并且没有错误，说明配置成功。

## ⚠️ 重要提示

1. **不要提交 `.env.local` 到 Git**
   - 该文件已在 `.gitignore` 中
   - 包含敏感信息（数据库密码、API 密钥等）

2. **使用不同的环境变量文件**
   - `.env.local` - 本地开发（优先级最高）
   - `.env.development.local` - 开发环境
   - `.env.production.local` - 生产环境
   - `.env` - 默认配置（可以提交到 Git）

3. **环境变量优先级**
   ```
   .env.local > .env.development.local > .env.development > .env
   ```

4. **Neon PostgreSQL 连接**
   - 应用运行和 seed 脚本：使用带 `-pooler` 的连接字符串
   - Prisma 迁移：如果遇到问题，可以尝试使用非连接池连接

## 🐛 常见问题

### Q: seed 脚本提示找不到 DATABASE_URL？

A: 确保：
1. `.env.local` 文件存在于项目根目录
2. `DATABASE_URL` 变量名拼写正确
3. 连接字符串用引号包裹（如果包含特殊字符）

### Q: 连接数据库失败？

A: 检查：
1. 连接字符串是否正确
2. 网络是否可以访问数据库服务器
3. SSL 模式是否正确（Neon 需要 `sslmode=require`）
4. 数据库用户名和密码是否正确

### Q: Prisma 迁移时连接超时？

A: 尝试：
1. 使用非连接池连接（`DATABASE_URL_UNPOOLED`）
2. 增加连接超时时间
3. 检查网络连接

## 📚 参考资源

- [Next.js 环境变量文档](https://nextjs.org/docs/basic-features/environment-variables)
- [Prisma 环境变量文档](https://www.prisma.io/docs/concepts/more/environment-variables)
- [Neon PostgreSQL 文档](https://neon.tech/docs)

