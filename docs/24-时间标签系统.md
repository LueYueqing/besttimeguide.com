# 时间标签系统文档

## 概述

时间标签系统是为 besttimeguide.com 网站设计的核心功能，它能够自动为文章生成时间相关的标签（季节、月份、周），帮助用户快速找到"最佳时间"相关的内容。

## 系统架构

### 1. 核心模块 (`lib/auto-time-tags.ts`)

提供三个主要函数：

#### `generateAutoTimeTags(title, content, category, existingTags)`
- **功能**: 根据文章内容自动生成时间标签
- **输入**: 
  - `title`: 文章标题
  - `content`: 文章内容
  - `category`: 文章分类
  - `existingTags`: 用户手动指定的标签
- **输出**: 合并后的标签数组（包含原有标签 + 自动生成的时间标签）
- **逻辑**:
  1. 分析标题和内容中的时间关键词
  2. 识别相关的季节、月份、周
  3. 根据文章主题生成最佳时间标签
  4. 保留用户手动指定的非时间标签

#### `updateTimeTags(existingTags, title, content, category)`
- **功能**: 更新现有文章的时间标签
- **特点**: 保留非时间标签，只更新时间相关标签
- **使用场景**: 文章内容更新后重新生成时间标签

#### `validateTimeTags(tags)`
- **功能**: 验证时间标签格式是否正确
- **输出**: 验证结果对象 `{ valid: boolean, errors: string[] }`

#### `getTimeTagDescription(tag)`
- **功能**: 获取时间标签的可读描述
- **示例**: `season-spring` → "Best time in Spring (March-May)"

### 2. 集成点

#### 文章创建 API (`app/api/articles/route.ts`)
```typescript
// 自动生成时间标签
const autoTags = generateAutoTimeTags(
  title,
  content || '',
  category.name,
  tags && Array.isArray(tags) ? tags : []
)

// 保存到数据库
tags: JSON.stringify(autoTags)
```

#### 文章更新 API (`app/api/articles/[slug]/route.ts`)
```typescript
// 当标题、内容或分类发生变化时，重新生成时间标签
if (tags !== undefined || title !== undefined || content !== undefined || categoryId !== undefined) {
  const autoTags = generateAutoTimeTags(
    currentTitle,
    currentContent,
    currentCategory?.name || '',
    userTags
  )
  tagsJson = JSON.stringify(autoTags)
}
```

#### AI 生成 API (`app/api/articles/ai-generate/route.ts`)
```typescript
// AI 生成完成后，自动添加时间标签
const autoTags = generateAutoTimeTags(
  articleForTags?.title || '',
  currentContent,
  articleForTags?.category?.name || '',
  []
)

// 保存时间标签
tags: JSON.stringify(autoTags)
```

### 3. 时间标签规则

#### 季节标签
- `season-spring`: 春季最佳时间 (3-5月)
- `season-summer`: 夏季最佳时间 (6-8月)
- `season-autumn`: 秋季最佳时间 (9-11月)
- `season-winter`: 冬季最佳时间 (12-2月)

#### 月份标签
- `month-january` 到 `month-december`: 各月份最佳时间

#### 周标签
- `week-1` 到 `week-52`: 各周最佳时间

#### 关键词映射规则

| 关键词 | 生成的标签 |
|--------|-----------|
| spring, march, april, may | season-spring, month-march/april/may |
| summer, june, july, august | season-summer, month-june/july/august |
| autumn, september, october, november | season-autumn, month-september/october/november |
| winter, december, january, february | season-winter, month-december/january/february |
| christmas | season-winter, month-december, week-51/52 |
| new year | season-winter, month-january, week-1/52 |
| black friday | season-autumn, month-november, week-47/48 |

## 使用流程

### 新建文章
1. 管理员填写文章信息（标题、内容、分类等）
2. 系统自动分析内容并生成时间标签
3. 时间标签与用户手动标签合并保存
4. 文章发布

### 更新文章
1. 管理员修改文章标题、内容或分类
2. 系统检测到变化，重新生成时间标签
3. 保留原有的非时间标签
4. 更新时间标签

### AI 生成文章
1. 管理员创建文章草稿（无内容）
2. AI 生成文章内容
3. 系统根据生成的内容自动添加时间标签
4. 文章自动发布

## 数据库结构

```prisma
model Article {
  // ... 其他字段
  tags String?  // JSON 格式存储标签数组
  // 示例: '["travel", "japan", "season-spring", "month-march", "month-april"]'
}
```

## 测试

运行测试脚本验证功能：

```bash
npx tsx scripts/test-auto-time-tags.ts
```

测试用例包括：
1. 春季旅游文章
2. 夏季购物文章
3. 冬季圣诞购物
4. 健康健身文章
5. 社交媒体发布
6. 通用文章（无时间关键词）
7. 标签更新功能

## 最佳实践

### 1. 标签命名规范
- 时间标签格式: `season-{season}`, `month-{month}`, `week-{week}`
- 用户标签: 使用 kebab-case，如 `travel-tips`, `shopping-guide`

### 2. 内容优化建议
为了获得更准确的时间标签，文章内容应：
- 在标题中明确时间主题
- 在正文中包含相关时间关键词
- 提供具体的时间建议

### 3. 标签管理
- 信任自动生成的时间标签
- 手动添加主题相关的关键词标签
- 避免手动添加时间标签（系统会自动处理）

## 前端使用

### 显示时间标签
```tsx
import { getTimeTagDescription } from '@/lib/auto-time-tags'

// 在文章详情页显示标签
{tags
  .filter(tag => tag.startsWith('season-') || tag.startsWith('month-') || tag.startsWith('week-'))
  .map(tag => (
    <span key={tag} className="time-tag">
      {getTimeTagDescription(tag)}
    </span>
  ))
}
```

### 按时间标签筛选
```tsx
// 在文章列表页添加时间筛选
<TimeFilter 
  options={[
    { value: 'season-spring', label: 'Spring' },
    { value: 'season-summer', label: 'Summer' },
    // ...
  ]}
  onChange={(tag) => filterArticles(tag)}
/>
```

## 维护和扩展

### 添加新的时间关键词
编辑 `lib/auto-time-tags.ts` 中的关键词映射：

```typescript
const seasonalKeywords = {
  // 添加新的关键词
  'chinese-new-year': {
    seasons: ['winter'],
    months: ['january', 'february'],
    weeks: []
  }
}
```

### 自定义时间标签生成逻辑
修改 `generateAutoTimeTags` 函数，根据业务需求调整：
- 添加更复杂的关键词匹配
- 考虑地理位置因素
- 增加业务规则判断

## 性能优化

1. **缓存时间标签**: 对于相同内容的文章，可以缓存生成的标签
2. **批量处理**: 对于大量文章更新，使用批量操作
3. **异步处理**: AI 生成时，时间标签生成可以异步进行

## 故障排查

### 问题：时间标签没有生成
- 检查文章标题和内容是否包含时间关键词
- 确认分类是否正确
- 查看日志确认函数是否被调用

### 问题：时间标签不准确
- 审查关键词映射规则
- 检查文章内容的时间上下文
- 考虑调整关键词权重

### 问题：标签格式错误
- 使用 `validateTimeTags` 函数验证
- 检查数据库中的标签格式
- 确认 JSON 序列化/反序列化正确

## 未来改进

1. **智能分析**: 使用 NLP 模型更准确地理解时间上下文
2. **地理位置**: 根据用户位置提供本地化的时间建议
3. **动态调整**: 根据用户行为数据优化时间标签
4. **多语言支持**: 支持中文等其他语言的时间关键词
5. **可视化**: 提供时间标签的可视化展示

## 相关文档

- [时间标签使用指南](docs/23-时间标签使用指南.md)
- [技术架构与代码规范](docs/02-技术架构与代码规范.md)
- [内容组织方案](docs/17-besttimeguide-内容组织方案.md)
